<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Settings - FX CORE AUTO</title>

<link rel="stylesheet" href="./css/base.css">
<link rel="stylesheet" href="./css/layout.css">
<link rel="stylesheet" href="./css/cards.css">
<link rel="stylesheet" href="./css/buttons.css">
<link rel="stylesheet" href="./css/header.css">
<link rel="stylesheet" href="./css/utilities.css">

<style>
.settingInput{
  width:90px;
  padding:6px;
  border-radius:8px;
  border:none;
  text-align:right;
}
</style>
</head>

<body>

<div class="wrap">
  <h1>SETTINGS</h1>

  <div id="settingsRoot"></div>

  <div class="card btnCard">
    <button onclick="saveSettings()">SAVE</button>
    <button onclick="resetSettings()">RESET</button>
    <button onclick="location.href='index.html'">BACK</button>
  </div>
</div>

<script type="module">
import { loadConfig, saveConfig, resetConfig } from "./js/config.js";

const root = document.getElementById("settingsRoot");
let config = loadConfig();

/* ========= INPUT ========= */

function numberInput(label, path, value){
  return `
    <div class="row">
      <span>${label}</span>
      <input type="number" step="0.01"
        data-path="${path}"
        value="${value}"
        class="settingInput" />
    </div>
  `;
}

/* ========= SECTION ========= */

function buildSection(title, obj, prefix){
  let html = `<div class="card"><h3>${title}</h3>`;

  for(const key in obj){
    if(typeof obj[key] === "object"){
      html += buildSection(key, obj[key], prefix + "." + key);
    }else{
      const label = key.replace(/([A-Z])/g," $1");
      html += numberInput(label, prefix + "." + key, obj[key]);
    }
  }

  html += "</div>";
  return html;
}

/* ========= RENDER ========= */

root.innerHTML =
  buildSection("GLOBAL", {
    envThresholdHigh: config.envThresholdHigh,
    envThresholdLow: config.envThresholdLow,
    usdStrongThreshold: config.usdStrongThreshold
  }, "") +

  buildSection("TREND", config.trend, "trend") +
  buildSection("RANGE", config.range, "range");

/* ========= SAVE ========= */

window.saveSettings = function(){

  document.querySelectorAll(".settingInput").forEach(input=>{
    const path = input.dataset.path.split(".");
    let ref = config;

    if(path[0] === ""){
      // global設定
      ref[path[1]] = parseFloat(input.value);
      return;
    }

    for(let i=0;i<path.length-1;i++){
      ref = ref[path[i]];
    }

    ref[path[path.length-1]] = parseFloat(input.value);
  });

  saveConfig(config);
  alert("Saved ✔");
};

/* ========= RESET ========= */

window.resetSettings = function(){
  if(confirm("Reset to default?")){
    resetConfig();
    location.reload();
  }
};

</script>
</body>
</html>