<script>

function fmt(n){
  return (typeof n==="number") ? n.toFixed(3) : "--";
}

async function autoAnalyze(){
  const res = await fetch('/api/market',{cache:"no-store"});
  const data = await res.json();

  document.getElementById("usdPrice").innerText = fmt(data.usdjpy?.price);
  document.getElementById("usdChange").innerText = fmt(data.usdjpy?.change);
  document.getElementById("usdRsi").innerText = fmt(data.usdjpy?.rsi);

  document.getElementById("sp").innerText = fmt(data.spPct);
  document.getElementById("vix").innerText = fmt(data.vixPct);
  document.getElementById("tlt").innerText = fmt(data.tltPct);
  document.getElementById("dxy").innerText = fmt(data.dxyPct);

  analyze(data);
}

function analyze(data){

  let riskScore=0;
  if(data.spPct>0) riskScore++;
  if(data.spPct<0) riskScore--;
  if(data.vixPct<0) riskScore++;
  if(data.vixPct>0) riskScore--;
  if(data.tltPct<0) riskScore++;
  if(data.tltPct>0) riskScore--;

  let usdScore=0;
  if(data.dxyPct>0) usdScore++;
  if(data.dxyPct<0) usdScore--;

  let totalScore=riskScore+usdScore;

  document.getElementById("riskScore").innerText=riskScore;
  document.getElementById("usdScore").innerText=usdScore;
  document.getElementById("totalScore").innerText=totalScore;

  let env="MIXED";
  if(riskScore>=2) env="RISK ON";
  if(riskScore<=-2) env="RISK OFF";

  let dir="NEUTRAL";
  if(usdScore>0) dir="USD STRONG";
  if(usdScore<0) dir="USD WEAK";

  let rsiSignal="NORMAL";
  if(data.usdjpy?.rsi>=70) rsiSignal="OVERBOUGHT";
  if(data.usdjpy?.rsi<=30) rsiSignal="OVERSOLD";

  let order="NO TRADE";
  if(totalScore>=3 && rsiSignal==="NORMAL") order="LONG";
  if(totalScore<=-3 && rsiSignal==="NORMAL") order="SHORT";

  document.getElementById("env").innerText=env;
  document.getElementById("dir").innerText=dir;
  document.getElementById("rsiSignal").innerText=rsiSignal;
  document.getElementById("order").innerText=order;
}

</script>