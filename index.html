<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>FX CORE AUTO</title>

<style>
:root{
  --c:#00ffc3;
  --bg:#000;
  --box:rgba(0,0,0,0.55);
  --border:2px solid var(--c);
  --danger:#ff3b7f;
}

/* ===== BASE ===== */
body{
  margin:0;
  background:var(--bg);
  color:var(--c);
  font-family:monospace;
  text-align:center;
  transition:0.3s ease;
}
h1{ margin:20px 0; }

.wrap{
  width:92%;
  max-width:560px;
  margin:0 auto;
}
.box{
  border:var(--border);
  margin:12px 0;
  padding:12px;
  background:var(--box);
  transition:0.3s ease;
}
.row{
  display:flex;
  justify-content:space-between;
}
button{
  background:var(--danger);
  color:#000;
  padding:10px 25px;
  border:none;
  font-weight:bold;
  cursor:pointer;
  margin:5px 0;
}
iframe{
  border:0;
  width:100%;
  height:420px;
}

/* ===== THEME ===== */
body.long-mode{
  --c:#ff3b7f;
  --border:2px solid #ff3b7f;
}
body.short-mode{
  --c:#3ba6ff;
  --border:2px solid #3ba6ff;
}
body.range-mode{
  --c:#00ffc3;
  --border:2px solid #00ffc3;
}
</style>
</head>

<body class="range-mode">

<h1>FX CORE AUTO</h1>
<div class="wrap">

<div class="box">
  <div class="row"><span>USDJPY</span><span id="usdPrice">--</span></div>
  <div class="row"><span>CHANGE</span><span id="usdChange">--</span></div>
  <div class="row"><span>RSI</span><span id="usdRsi">--</span></div>
</div>

<div class="box">
  <div class="row"><span>SPX</span><span id="sp">--</span></div>
  <div class="row"><span>VIX</span><span id="vix">--</span></div>
  <div class="row"><span>TLT</span><span id="tlt">--</span></div>
  <div class="row"><span>DXY</span><span id="dxy">--</span></div>
</div>

<div class="box">
  <div class="row"><span>ENV</span><span id="env">--</span></div>
  <div class="row"><span>DIR</span><span id="dir">--</span></div>
  <div class="row"><span>RSI SIGNAL</span><span id="rsiSignal">--</span></div>
  <div class="row"><span>ORDER</span><span id="order">--</span></div>
</div>

<button onclick="saveEntry()">SAVE ENTRY</button>

<div class="box">
  <div class="row"><span>RISK SCORE</span><span id="riskScore">--</span></div>
  <div class="row"><span>USD SCORE</span><span id="usdScore">--</span></div>
  <div class="row"><span>TOTAL SCORE</span><span id="totalScore">--</span></div>
</div>

<div class="box">
  <button onclick="autoAnalyze()">AUTO ANALYZE</button>
</div>

<div class="box">
  <iframe src="chart.html"></iframe>
</div>

</div>

<script type="module">

import { calcScore } from './score.js';
import { saveEntry } from './logs.js';

function fmt(n){
  return (typeof n === "number") ? n.toFixed(3) : "--";
}

async function autoAnalyze(){
  try{
    const res = await fetch('/api/market',{cache:"no-store"});
    const data = await res.json();

    document.getElementById("usdPrice").innerText = fmt(data.usdjpy?.price);
    document.getElementById("usdChange").innerText = fmt(data.usdjpy?.changePct);
    document.getElementById("usdRsi").innerText = fmt(data.usdjpy?.rsi);

    document.getElementById("sp").innerText = fmt(data.spPct);
    document.getElementById("vix").innerText = fmt(data.vixPct);
    document.getElementById("tlt").innerText = fmt(data.tltPct);
    document.getElementById("dxy").innerText = fmt(data.dxyPct);

    analyze(data);

  }catch(e){
    console.error(e);
    alert("API error");
  }
}

function analyze(data){

  const { riskScore, usdScore, totalScore } = calcScore(data);

  document.getElementById("riskScore").innerText = riskScore;
  document.getElementById("usdScore").innerText = usdScore;
  document.getElementById("totalScore").innerText = totalScore;

  let env="MIXED";
  if(riskScore>=2) env="RISK ON";
  if(riskScore<=-2) env="RISK OFF";

  let dir="NEUTRAL";
  if(usdScore>0) dir="USD STRONG";
  if(usdScore<0) dir="USD WEAK";

  let rsiSignal="NORMAL";
  let rsi=data.usdjpy?.rsi;
  if(rsi>=70) rsiSignal="OVERBOUGHT";
  if(rsi<=30) rsiSignal="OVERSOLD";

  let order="NO TRADE";

  if(totalScore>=3 && rsiSignal==="NORMAL"){
    order="LONG (trend)";
  }
  else if(totalScore<=-3 && rsiSignal==="NORMAL"){
    order="SHORT (trend)";
  }
  else if(env==="RISK OFF" && rsiSignal==="OVERSOLD"){
    order="LONG (counter)";
  }
  else if(env==="RISK ON" && rsiSignal==="OVERBOUGHT"){
    order="SHORT (counter)";
  }

  document.getElementById("env").innerText=env;
  document.getElementById("dir").innerText=dir;
  document.getElementById("rsiSignal").innerText=rsiSignal;
  document.getElementById("order").innerText=order;

  applyTheme(order);
}

/* ===== THEME SWITCH ===== */
function applyTheme(order){

  document.body.classList.remove("long-mode","short-mode","range-mode");

  if(order.includes("LONG")){
    document.body.classList.add("long-mode");
  }
  else if(order.includes("SHORT")){
    document.body.classList.add("short-mode");
  }
  else{
    document.body.classList.add("range-mode");
  }
}

window.autoAnalyze = autoAnalyze;
window.saveEntry = saveEntry;

</script>

</body>
</html>