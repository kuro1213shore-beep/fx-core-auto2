<script type="module">

import { calcScore } from './score.js';
import { saveEntry } from './logs.js';

function fmt(n){
  return (typeof n === "number") ? n.toFixed(3) : "--";
}

async function autoAnalyze(){
  try{
    const res = await fetch('/api/market',{cache:"no-store"});
    const data = await res.json();

    document.getElementById("usdPrice").innerText = fmt(data.usdjpy?.price);
    document.getElementById("usdChange").innerText = fmt(data.usdjpy?.changePct);
    document.getElementById("usdRsi").innerText = fmt(data.usdjpy?.rsi);

    document.getElementById("sp").innerText = fmt(data.spPct);
    document.getElementById("vix").innerText = fmt(data.vixPct);
    document.getElementById("tlt").innerText = fmt(data.tltPct);
    document.getElementById("dxy").innerText = fmt(data.dxyPct);

    analyze(data);

  }catch(e){
    console.error(e);
    alert("API error");
  }
}

function analyze(data){

  const { riskScore, usdScore, totalScore } = calcScore(data);

  document.getElementById("riskScore").innerText = riskScore;
  document.getElementById("usdScore").innerText = usdScore;
  document.getElementById("totalScore").innerText = totalScore;

  const mode = data.usdjpy?.marketMode || "RANGE";

  let env="MIXED";
  if(riskScore>=2) env="RISK ON";
  if(riskScore<=-2) env="RISK OFF";

  let dir="NEUTRAL";
  if(usdScore>0) dir="USD STRONG";
  if(usdScore<0) dir="USD WEAK";

  let rsiSignal="NORMAL";
  const rsi=data.usdjpy?.rsi;
  if(rsi>=70) rsiSignal="OVERBOUGHT";
  if(rsi<=30) rsiSignal="OVERSOLD";

  let order="NO TRADE";

  if(mode==="DOWNTREND"){
    if(totalScore<=-1 && rsiSignal!=="OVERSOLD"){
      order="SHORT (trend)";
    }
  }
  else if(mode==="UPTREND"){
    if(totalScore>=1 && rsiSignal!=="OVERBOUGHT"){
      order="LONG (trend)";
    }
  }
  else{
    if(env==="RISK OFF" && rsiSignal==="OVERSOLD"){
      order="LONG (counter)";
    }
    else if(env==="RISK ON" && rsiSignal==="OVERBOUGHT"){
      order="SHORT (counter)";
    }
  }

  document.getElementById("env").innerText=env;
  document.getElementById("dir").innerText=dir;
  document.getElementById("rsiSignal").innerText=rsiSignal;
  document.getElementById("order").innerText=order;

  applyTheme(mode);
}

function applyTheme(mode){

  document.body.classList.remove("long-mode","short-mode","range-mode");

  if(mode==="UPTREND"){
    document.body.classList.add("long-mode");
  }
  else if(mode==="DOWNTREND"){
    document.body.classList.add("short-mode");
  }
  else{
    document.body.classList.add("range-mode");
  }
}

window.autoAnalyze = autoAnalyze;
window.saveEntry = saveEntry;

</script>