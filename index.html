<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FX CORE AUTO</title>

  <style>
    :root{
      --c:#00ffc3;              /* default = range */
      --bg:#000;
      --box:rgba(0,0,0,0.55);
      --border:2px solid var(--c);
      --danger:#ff3b7f;
    }

    /* ===== BASE ===== */
    body{
      margin:0;
      background:var(--bg);
      color:var(--c);
      font-family:monospace;
      text-align:center;
      transition:0.25s ease;
    }
    h1{ margin:22px 0 18px; letter-spacing:2px; }

    .wrap{
      width:92%;
      max-width:560px;
      margin:0 auto 40px;
    }

    .box{
      border:var(--border);
      margin:14px 0;
      padding:14px;
      background:var(--box);
      transition:0.25s ease;
    }

    .row{
      display:flex;
      justify-content:space-between;
      gap:12px;
      white-space:nowrap;
      font-size:18px;
      line-height:1.35;
    }

    .muted{
      opacity:0.75;
      font-size:12px;
      margin-top:8px;
      text-align:right;
    }

    .btnRow{
      display:flex;
      justify-content:space-between;
      gap:14px;
      margin:8px 0;
    }

    button{
      flex:1;
      background:var(--danger);
      color:#000;
      padding:14px 10px;
      border:none;
      font-weight:900;
      cursor:pointer;
      letter-spacing:1px;
      font-size:16px;
    }

    iframe{
      border:0;
      width:100%;
      height:420px;
    }

    /* ===== THEME (ui.js が class を付け替える前提) ===== */
    body.long-mode{
      --c:#ff3b7f;              /* LONG = pink */
      --border:2px solid #ff3b7f;
    }
    body.short-mode{
      --c:#3ba6ff;              /* SHORT = blue */
      --border:2px solid #3ba6ff;
    }
    body.range-mode{
      --c:#00ffc3;              /* RANGE = green */
      --border:2px solid #00ffc3;
    }
  </style>
</head>

<body class="range-mode">
  <h1>FX CORE AUTO</h1>

  <div class="wrap">

    <!-- ===== PRICE ===== -->
    <div class="box">
      <div class="row"><span>USDJPY</span><span id="usdPrice">--</span></div>
      <div class="row"><span>CHANGE</span><span id="usdChange">--</span></div>
      <div class="row"><span>RSI</span><span id="usdRsi">--</span></div>
      <div class="muted" id="updatedAt">--</div>
    </div>

    <!-- ===== MARKET ===== -->
    <div class="box">
      <div class="row"><span>SPX</span><span id="sp">--</span></div>
      <div class="row"><span>VIX</span><span id="vix">--</span></div>
      <div class="row"><span>TLT</span><span id="tlt">--</span></div>
      <div class="row"><span>DXY</span><span id="dxy">--</span></div>
    </div>

    <!-- ===== MODE ===== -->
    <div class="box">
      <div class="row"><span>MARKET MODE</span><span id="mode">--</span></div>
    </div>

    <!-- ===== SIGNAL ===== -->
    <div class="box">
      <div class="row"><span>ENV</span><span id="env">--</span></div>
      <div class="row"><span>DIR</span><span id="dir">--</span></div>
      <div class="row"><span>RSI SIGNAL</span><span id="rsiSignal">--</span></div>
      <div class="row"><span>ORDER</span><span id="order">--</span></div>
    </div>

    <!-- ===== SCORE ===== -->
    <div class="box">
      <div class="row"><span>RISK SCORE</span><span id="riskScore">--</span></div>
      <div class="row"><span>USD SCORE</span><span id="usdScore">--</span></div>
      <div class="row"><span>TOTAL SCORE</span><span id="totalScore">--</span></div>
    </div>

    <!-- ===== BUTTONS ===== -->
    <div class="box">
      <div class="btnRow">
        <button onclick="autoAnalyze()">AUTO ANALYZE</button>
        <button onclick="saveEntry()">SAVE ENTRY</button>
      </div>
    </div>

    <!-- ===== CHART ===== -->
    <div class="box">
      <iframe src="chart.html" loading="lazy"></iframe>
    </div>

  </div>

  <script type="module">
    import { calcScore } from "./score.js";
    import { analyzeLogic } from "./engine.js";
    import { updateUI } from "./ui.js";
    import { saveEntry } from "./logs.js";

    function fmt(n){
      return (typeof n === "number" && Number.isFinite(n)) ? Number(n).toFixed(3) : "--";
    }

    function setText(id, value){
      const el = document.getElementById(id);
      if(el) el.innerText = value;
    }

    async function autoAnalyze(){
      try{
        const res = await fetch("/api/market", { cache:"no-store" });
        if(!res.ok) throw new Error("API HTTP " + res.status);

        const data = await res.json();

        // raw numbers
        setText("usdPrice",  fmt(data.usdjpy?.price));
        setText("usdChange", fmt(data.usdjpy?.changePct));
        setText("usdRsi",    fmt(data.usdjpy?.rsi));

        setText("sp",  fmt(data.spPct));
        setText("vix", fmt(data.vixPct));
        setText("tlt", fmt(data.tltPct));
        setText("dxy", fmt(data.dxyPct));

        setText("updatedAt", data.updatedAt ? data.updatedAt : "--");

        // scores
        const { riskScore, usdScore, totalScore } = calcScore(data);
        setText("riskScore", String(riskScore));
        setText("usdScore",  String(usdScore));
        setText("totalScore",String(totalScore));

        // logic + ui
        const result = analyzeLogic(data, riskScore, usdScore, totalScore);

        // market mode表示（テーマも ui.js で反映）
        setText("mode", result.mode || data.usdjpy?.marketMode || "RANGE");

        updateUI(result);

      }catch(e){
        console.error(e);
        alert("API ERROR");
      }
    }

    window.autoAnalyze = autoAnalyze;
    window.saveEntry = saveEntry;
  </script>
</body>
</html>