<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>FX CORE AUTO</title>

<style>
body {
  background:black;
  color:#00ffc3;
  font-family:monospace;
  text-align:center;
}

h1 {
  margin-top:30px;
  font-size:32px;
}

.box {
  border:2px solid #00ffc3;
  margin:15px auto;
  padding:15px;
  width:90%;
  max-width:500px;
  font-size:18px;
}

button {
  background:#ff3b7f;
  color:black;
  padding:10px 30px;
  border:none;
  margin-top:20px;
  font-weight:bold;
  cursor:pointer;
}

.status {
  margin-top:10px;
  font-size:14px;
  opacity:0.7;
}
</style>
</head>

<body>

<h1>FX CORE AUTO</h1>

<div class="box">USDJPY: <span id="usdPrice">--</span></div>
<div class="box">CHANGE: <span id="usdChange">--</span></div>
<div class="box">RSI(14): <span id="usdRsi">--</span></div>
<div class="box">US10Y: <span id="us10y">--</span></div>

<div class="box">ENV: <span id="env">--</span></div>
<div class="box">DIR: <span id="dir">--</span></div>
<div class="box">RSI SIGNAL: <span id="rsiSignal">--</span></div>
<div class="box">ORDER: <span id="order">--</span></div>

<div class="box">
  <label>
    <input type="checkbox" id="autoRefresh">
    Auto refresh (15s)
  </label>
  <div class="status" id="status">Ready.</div>
</div>

<button onclick="autoAnalyze()">AUTO ANALYZE</button>

<script>

let timer = null;

async function autoAnalyze() {
  try {
    const res = await fetch('/api/market');
    const data = await res.json();

    const usd = data.usdjpy || {};
    const us10y = data.us10y;

    document.getElementById("usdPrice").innerText =
      typeof usd.price === "number" ? usd.price.toFixed(3) : "--";

    document.getElementById("usdChange").innerText =
      typeof usd.change === "number" ? usd.change : "--";

    document.getElementById("usdRsi").innerText =
      typeof usd.rsi === "number" ? usd.rsi.toFixed(1) : "--";

    document.getElementById("us10y").innerText =
      typeof us10y === "number" ? us10y.toFixed(3) : "--";

    analyze(data);

    document.getElementById("status").innerText = "Updated.";

  } catch (e) {
    console.error(e);
    document.getElementById("status").innerText = "Fetch error.";
  }
}

function analyze(data) {

  // ===== ENV判定 =====
  let env = "RANGE";

  if (data.sp > 0.5 && data.vix < -0.5) {
    env = "RISK ON";
  }

  if (data.sp < -0.5 && data.vix > 0.5) {
    env = "RISK OFF";
  }

  document.getElementById("env").innerText = env;


  // ===== DIR判定（金利込み） =====
  let dir = "NEUTRAL";

  if (data.dxy > 0.3 && data.us10y > 0.02) {
    dir = "USD STRONG";
  }

  if (data.dxy < -0.3 && data.us10y < -0.02) {
    dir = "USD WEAK";
  }

  document.getElementById("dir").innerText = dir;


  // ===== RSI判定 =====
  let rsiSignal = "NORMAL";

  if (data.usdjpy?.rsi > 70) rsiSignal = "OVERBOUGHT";
  if (data.usdjpy?.rsi < 30) rsiSignal = "OVERSOLD";

  document.getElementById("rsiSignal").innerText = rsiSignal;


  // ===== ORDERロジック =====
  let order = "NO TRADE";

  if (env === "RISK ON" && dir === "USD WEAK") {
    order = "BUY";
  }

  if (env === "RISK OFF" && dir === "USD STRONG") {
    order = "SELL";
  }

  document.getElementById("order").innerText = order;
}


// ===== Auto Refresh =====
document.getElementById("autoRefresh").addEventListener("change", function(e){
  if (e.target.checked) {
    autoAnalyze();
    timer = setInterval(autoAnalyze, 15000);
    document.getElementById("status").innerText = "Auto refresh ON.";
  } else {
    clearInterval(timer);
    timer = null;
    document.getElementById("status").innerText = "Auto refresh OFF.";
  }
});

</script>

<div style="margin-top:40px;">
  <iframe
    src="https://s.tradingview.com/widgetembed/?frameElementId=tradingview_chart&symbol=FX:USDJPY&interval=15&hidesidetoolbar=1&theme=dark"
    width="100%"
    height="400"
    frameborder="0"
  ></iframe>
</div>

</body>
</html>