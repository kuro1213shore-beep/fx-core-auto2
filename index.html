<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>FX CORE AUTO</title>
  <link rel="preconnect" href="https://s3.tradingview.com">
  <style>
    :root{
      --bg:#06080b;
      --panel:#070b10;
      --border:#1ef0c7;
      --text:#baf7ea;
      --muted:#5bd7c2;
      --accent:#ff3d87;
      --shadow: 0 0 0.8rem rgba(30,240,199,.18);
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: ui-monospace, Menlo, Monaco, Consolas, "SF Mono", monospace;
      letter-spacing:.02em;
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px 14px 36px}
    h1{
      margin:6px 0 16px; text-align:center; font-weight:800;
      color:var(--border); letter-spacing:.18em;
      text-shadow: 0 0 12px rgba(30,240,199,.25);
    }
    .grid{display:grid;gap:14px}
    .panel{
      background:linear-gradient(180deg, rgba(7,11,16,.98), rgba(6,8,11,.98));
      border:2px solid var(--border);
      border-radius:14px;
      padding:14px;
      box-shadow: var(--shadow);
    }
    .row{display:flex;justify-content:space-between;gap:12px;align-items:baseline}
    .k{color:var(--muted)}
    .v{font-weight:700}
    .btn{
      width:100%; border:none; border-radius:12px;
      background:var(--accent); color:#0b0e12;
      font-weight:900; letter-spacing:.12em;
      padding:14px 12px; cursor:pointer;
      box-shadow: 0 0 14px rgba(255,61,135,.18);
    }
    .btn:active{transform:translateY(1px)}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border:1px solid rgba(30,240,199,.55);
      border-radius:999px; color:var(--text);
    }
    .small{font-size:12px;color:var(--muted)}
    .muted{color:var(--muted)}
    .tag{font-weight:800}
    .ok{color:#7CFFB2}
    .ng{color:#FF6B6B}
    iframe{width:100%;border:0;border-radius:14px;overflow:hidden}
    .two{display:grid;gap:14px}
    @media(min-width:860px){.two{grid-template-columns:1fr 1fr}}
    .sep{height:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>FX CORE AUTO</h1>

    <div class="grid">
      <div class="panel" id="panelTop">
        <div class="row"><div class="k">USDJPY</div><div class="v" id="p_usdjpy">--</div></div>
        <div class="row"><div class="k">CHANGE</div><div class="v" id="p_change">--</div></div>
        <div class="row"><div class="k">RSI(14)</div><div class="v" id="p_rsi">--</div></div>
        <div class="sep"></div>
        <div class="small" id="p_meta">source=-- | updated=--</div>
      </div>

      <div class="panel">
        <div class="row"><div class="k">SPX</div><div class="v" id="p_spx">--</div></div>
        <div class="row"><div class="k">VIX</div><div class="v" id="p_vix">--</div></div>
        <div class="row"><div class="k">TLT</div><div class="v" id="p_tlt">--</div></div>
        <div class="row"><div class="k">DXY</div><div class="v" id="p_dxy">--</div></div>
        <div class="sep"></div>
        <div class="small muted">SP/VIX/TLT/DXY are snapshot % change</div>
      </div>

      <div class="panel">
        <div class="row"><div class="k">ENV</div><div class="v tag" id="s_env">--</div></div>
        <div class="row"><div class="k">DIR</div><div class="v tag" id="s_dir">--</div></div>
        <div class="row"><div class="k">RSI SIGNAL</div><div class="v tag" id="s_rsiSig">--</div></div>
        <div class="row"><div class="k">ORDER</div><div class="v tag" id="s_order">--</div></div>
        <div class="sep"></div>
        <div class="small" id="s_reason">--</div>
      </div>

      <div class="panel">
        <button class="btn" id="btnSave">SAVE ENTRY</button>
      </div>

      <div class="panel">
        <div class="row"><div class="k">RISK SCORE</div><div class="v" id="sc_risk">--</div></div>
        <div class="row"><div class="k">USD SCORE</div><div class="v" id="sc_usd">--</div></div>
        <div class="row"><div class="k">TOTAL SCORE</div><div class="v" id="sc_total">--</div></div>
        <div class="sep"></div>
        <div class="small muted">※投資助言ではない / 期待値とリスク管理の補助ツール</div>
      </div>

      <div class="panel">
        <button class="btn" id="btnAnalyze">AUTO ANALYZE</button>
        <div class="sep"></div>
        <div class="row">
          <label class="pill">
            <input type="checkbox" id="autoRefresh" checked />
            Auto refresh
          </label>
          <span class="pill small"><span id="refreshSec">15</span>s</span>
          <span class="pill small" id="statusPill">Idle</span>
        </div>
      </div>

      <div class="panel">
        <iframe src="./chart.html" height="520" loading="lazy"></iframe>
      </div>
    </div>
  </div>

  <script type="module">
    import { CONFIG } from './config.js'
    import { initUI, renderAll } from './ui.js'
    import { analyzeOnce } from './engine.js'
    import { saveEntry } from './logs.js'

    initUI()

    const statusEl = document.getElementById('statusPill')
    const secEl = document.getElementById('refreshSec')
    secEl.textContent = CONFIG.refreshSeconds

    async function run(){
      statusEl.textContent = 'Updating'
      try{
        const result = await analyzeOnce()
        renderAll(result)
        statusEl.textContent = 'Updated'
      }catch(e){
        console.error(e)
        statusEl.textContent = 'Error'
      }
    }

    document.getElementById('btnAnalyze').addEventListener('click', run)

    document.getElementById('btnSave').addEventListener('click', async ()=>{
      const latest = await analyzeOnce()
      saveEntry(latest)
      statusEl.textContent = 'Saved'
      renderAll(latest)
    })

    // Auto refresh
    let timer = null
    const chk = document.getElementById('autoRefresh')
    function arm(){
      clearInterval(timer)
      if(!chk.checked) return
      timer = setInterval(run, CONFIG.refreshSeconds*1000)
    }
    chk.addEventListener('change', arm)

    // first run
    await run()
    arm()
  </script>
</body>
</html>