<script type="module">

import { calcScore } from './score.js';

function fmt(n){
  return (typeof n === "number") ? Number(n).toFixed(3) : "--";
}

async function autoAnalyze(){
  try{
    const res = await fetch('/api/market',{cache:"no-store"});
    const data = await res.json();

    document.getElementById("usdPrice").innerText = fmt(data.usdjpy?.price);
    document.getElementById("usdChange").innerText = fmt(data.usdjpy?.changePct);
    document.getElementById("usdRsi").innerText = fmt(data.usdjpy?.rsi);

    document.getElementById("sp").innerText = fmt(data.spPct);
    document.getElementById("vix").innerText = fmt(data.vixPct);
    document.getElementById("tlt").innerText = fmt(data.tltPct);
    document.getElementById("dxy").innerText = fmt(data.dxyPct);

    const score = calcScore(data);
    console.log(score);

    document.getElementById("mode").innerText =
      data.usdjpy?.marketMode || "RANGE";

  }catch(e){
    console.error(e);
    alert("API ERROR");
  }
}

window.autoAnalyze = autoAnalyze;

</script>